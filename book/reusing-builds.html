<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reusing builds - cargo-nextest</title>


        <!-- Custom HTML head -->
        <meta name="twitter:card" content="summary_large_image" />
<meta property="og:title" content="Reusing builds - cargo-nextest" />
<meta property="og:image" content="https://nexte.st/static/cover.png" />
<meta property="og:description" content="A next-generation test runner for Rust." />

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A next-generation test runner for Rust.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/extra.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Home</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../book/installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/pre-built-binaries.html"><strong aria-hidden="true">1.1.</strong> Pre-built binaries</a></li><li class="chapter-item expanded "><a href="../book/installing-from-source.html"><strong aria-hidden="true">1.2.</strong> Installing from source</a></li><li class="chapter-item expanded "><a href="../book/antivirus-gatekeeper.html"><strong aria-hidden="true">1.3.</strong> Windows antivirus and macOS Gatekeeper</a></li></ol></li><li class="chapter-item expanded "><a href="../book/usage.html"><strong aria-hidden="true">2.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/running.html"><strong aria-hidden="true">2.1.</strong> Running tests</a></li><li class="chapter-item expanded "><a href="../book/listing.html"><strong aria-hidden="true">2.2.</strong> Listing tests</a></li><li class="chapter-item expanded "><a href="../book/retries.html"><strong aria-hidden="true">2.3.</strong> Retries and flaky tests</a></li><li class="chapter-item expanded "><a href="../book/partitioning.html"><strong aria-hidden="true">2.4.</strong> Partitioning test runs in CI</a></li><li class="chapter-item expanded "><a href="../book/target-runners.html"><strong aria-hidden="true">2.5.</strong> Target runners</a></li><li class="chapter-item expanded "><a href="../book/other-options.html"><strong aria-hidden="true">2.6.</strong> Other options</a></li><li class="chapter-item expanded "><a href="../book/env-vars.html"><strong aria-hidden="true">2.7.</strong> Environment variables</a></li></ol></li><li class="chapter-item expanded "><a href="../book/machine-readable.html"><strong aria-hidden="true">3.</strong> Machine-readable output</a></li><li class="chapter-item expanded "><a href="../book/configuration.html"><strong aria-hidden="true">4.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../book/junit.html"><strong aria-hidden="true">5.</strong> JUnit support</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../book/stability.html"><strong aria-hidden="true">6.</strong> Stability policy</a></li><li class="chapter-item expanded "><a href="../book/experimental-features.html"><strong aria-hidden="true">7.</strong> Experimental features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/reusing-builds.html" class="active"><strong aria-hidden="true">7.1.</strong> Reusing builds</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../book/how-it-works.html"><strong aria-hidden="true">8.</strong> How nextest works</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/benchmarks.html"><strong aria-hidden="true">8.1.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../book/custom-test-harnesses.html"><strong aria-hidden="true">8.2.</strong> Custom test harnesses</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../CHANGELOG.html">Changelog</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">cargo-nextest</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/nextest-rs/nextest" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/nextest-rs/nextest/edit/main/site/src/book/reusing-builds.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reusing-builds"><a class="header" href="#reusing-builds">Reusing builds</a></h1>
<ul>
<li><strong>Introduced in:</strong> cargo-nextest 0.9.10</li>
<li><strong>Environment variable</strong>: <code>NEXTEST_EXPERIMENTAL_REUSE_BUILD=1</code></li>
<li><strong>Tracking issue</strong>: <a href="https://github.com/nextest-rs/nextest/issues/98">#98</a></li>
</ul>
<p>In some cases, it can be useful to separate out building tests and running them. Nextest has experimental support for serializing metadata on one machine, and then using that to run tests on another machine.</p>
<h2 id="terms"><a class="header" href="#terms">Terms</a></h2>
<ul>
<li><strong>Build machine:</strong> The computer that builds tests.</li>
<li><strong>Target machine:</strong> The computer that runs tests.</li>
</ul>
<h2 id="use-cases"><a class="header" href="#use-cases">Use cases</a></h2>
<ul>
<li><strong>Cross-compilation.</strong> The build machine has a different architecture or operating system from the target machine.</li>
<li><strong>Partitioned execution.</strong> Build once on the build machine, then <a href="partitioning.html">partition test execution</a> across multiple target machines.</li>
<li><strong>Saving execution time on more valuable machines.</strong> For example, do not build on a GPU machine.</li>
</ul>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li><strong>The project source must be checked out to the same revision on the target machine.</strong> This might be needed for test fixtures and other assets, and nextest applies the right working directory relative to the workspace root when executing tests.</li>
<li><strong>It is your responsibility to transfer over build artifacts.</strong> Use the examples below as a template.</li>
</ul>
<h3 id="non-requirements"><a class="header" href="#non-requirements">Non-requirements</a></h3>
<ul>
<li><strong>Cargo does not need to be installed on the target machine.</strong> In this case, replace <code>cargo nextest</code> with <code>cargo-nextest nextest</code> in the following examples.</li>
</ul>
<h2 id="new-options"><a class="header" href="#new-options">New options</a></h2>
<p>Both <code>cargo nextest list</code> and <code>cargo nextest run</code> accept the following options:</p>
<ul>
<li><code>--binaries-metadata</code>: The path to JSON metadata generated by <code>cargo nextest list --list-binaries --message-format json</code>.</li>
<li><code>--binaries-dir-remap</code>: A possible new location for the directory test binaries are present in. Requires <code>--binaries-metadata</code>.</li>
<li><code>--cargo-metadata</code>: The path to JSON metadata generated by <code>cargo metadata --format-version 1</code>.</li>
<li><code>--workspace-remap</code>: A possible new location for the root of the workspace. requires <code>--cargo-metadata</code>.</li>
</ul>
<h2 id="example-simple-buildrun-split"><a class="header" href="#example-simple-buildrun-split">Example: Simple build/run split</a></h2>
<ol>
<li>Build the tests and save the binaries metadata:
<pre><code>cargo nextest list --list-type binaries-only --message-format json \
  &gt; target/binaries-metadata.json
</code></pre>
</li>
<li>List the tests:
<pre><code>cargo nextest list --binaries-metadata target/binaries-metadata.json
</code></pre>
</li>
<li>Run the tests:
<pre><code>cargo nextest run --binaries-metadata target/binaries-metadata.json
</code></pre>
</li>
</ol>
<h2 id="example-cross-compilation"><a class="header" href="#example-cross-compilation">Example: Cross-compilation</a></h2>
<p>While cross-compiling code, some tests may need to be run on the host platform. (See the note about <a href="running.html#filtering-by-build-platform">Filtering by build platform</a> for more.)</p>
<h3 id="on-the-build-machine"><a class="header" href="#on-the-build-machine">On the build machine</a></h3>
<ol>
<li>Save the project's cargo metadata:
<pre><code>cargo metadata --format-version=1 --all-features --no-deps \
  &gt; target/cargo-metadata.json
</code></pre>
</li>
<li>Build the tests and save the binaries metadata:
<pre><code>cargo nextest list --target &lt;TARGET&gt; --list-type binaries-only \
  --message-format json &gt; target/binaries-metadata.json
</code></pre>
</li>
<li>Run host-only tests:
<pre><code>cargo nextest run --platform-filter host
</code></pre>
</li>
<li>Archive artifacts: <code>target/cargo-metadata.json</code>, <code>target/binaries-metadata.json</code>, and test binaries.
<ul>
<li>With <a href="https://stedolan.github.io/jq/"><code>jq</code></a>, this can be done through <code>cat target/binaries-metadata.json | jq '.&quot;rust-binaries&quot; | .[] . &quot;binary-path&quot;</code>).</li>
</ul>
</li>
</ol>
<h3 id="on-the-target-machine"><a class="header" href="#on-the-target-machine">On the target machine</a></h3>
<ol>
<li>Check out the project repository to the same revision as the build machine.</li>
<li>Extract the artifacts archived on the build machine.</li>
<li>List target-only tests:
<pre><code>cargo nextest list --platform-filter target \
    --binaries-metadata &lt;PATH&gt;/binaries-metadata.json \
    --cargo-metadata &lt;PATH&gt;/cargo-metadata.json \
    --workspace-remap &lt;REPO-PATH&gt; \
    --binaries-dir-remap &lt;TESTS-FOLDER-PATH&gt;
</code></pre>
</li>
<li>Run target-only tests:
<pre><code>cargo nextest run --platform-filter target \
    --binaries-metadata &lt;PATH&gt;/binaries-metadata.json \
    --cargo-metadata &lt;PATH&gt;/cargo-metadata.json \
    --workspace-remap &lt;REPO-PATH&gt; \
    --binaries-dir-remap &lt;TESTS-FOLDER-PATH&gt;
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../book/experimental-features.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../book/how-it-works.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../book/experimental-features.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../book/how-it-works.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
